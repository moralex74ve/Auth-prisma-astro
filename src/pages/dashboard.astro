---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import UsuarioLogeado from '../components/UsuarioLogeado.astro';
import { prisma } from '../db';

// El middleware ya ha validado al usuario y lo ha puesto en Astro.locals.
// Si llegamos aquí, el usuario está autenticado.
const { user } = Astro.locals;

// Si por alguna razón el usuario no está en locals (aunque el middleware debería impedirlo),
// redirigimos por seguridad.
if (!user) {
  return Astro.redirect("/login");
}

// Obtener los datos completos del usuario desde la base de datos
// Usamos el ID del token JWT para buscar la información actualizada
const usuario = await prisma.usuarios.findUnique({
  where: { id: user.id },
  select: {
    nombre: true,
    correo: true,
    rol: true
  }
});

// Si no encontramos al usuario (por ejemplo, fue eliminado), cerramos la sesión
if (!usuario) {
  // Borrar la cookie de sesión
  Astro.cookies.delete("session", { path: "/" });
  return Astro.redirect("/login?error=user_not_found");
}
---

<Layout>
  <main class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-center mb-8">Dashboard</h1>
      
      <UsuarioLogeado 
        nombre={usuario.nombre}
        correo={usuario.correo}
        rol={usuario.rol}
      />
      
      <div class="mt-8 space-y-4">
        <form action="/api/logout" method="POST" class="mt-8 space-y-4">
          <button type="submit" class="w-full text-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
            Cerrar sesión
          </button>
        </form>
      </div>
    </div>
  </main>
</Layout>